<div class="" id="{{ .Params.id }}">
  <!-- <h3>Hugo Params</h3>
  {{ range $elem_key, $elem_val := .Params }}
  <b>{{ $elem_key }}</b>: <code>{{ $elem_val }}</code><br />
  {{ end }}

  <pre>
  .Site => {{ .Site }}
  .Site.Title => {{ .Site.Title }}
  .Page => {{ .Page }}
  .Page.Title => {{ .Page.Title }}
  </pre> -->

  <form data-form>
    <div id="envVarButtons" class="mb-4">
      <div id="envVar">
        <button
          id="newEnvVarBtn"
          data-add-query-param-btn
          class="mt-2 btn btn-outline-success"
          type="button"
        >
          Add Custom Environment Variable
        </button>
      </div>
    </div>
    <h2>Environment Variables</h2>
    <div id="{{ .Params.id }}-query-params">
      <div data-query-params></div>
    </div>
  </form>
  <template data-key-value-template>
    <div class="input-group my-2" data-key-value-pair>
      <input
        type="text"
        data-key
        class="form-control"
        placeholder="Key"
        value=""
        disabled
      />
      <input
        type="text"
        data-value
        class="form-control"
        placeholder="Value"
        value=""
        disabled
      />
      <button type="button" data-update-btn class="btn btn-outline-success">
        Update
      </button>
      <button type="button" data-remove-btn class="btn btn-outline-danger">
        Delete
      </button>
    </div>
  </template>
</div>

<script>
  const newEnvVarDialog = document.getElementById("newEnvVarDialog")
  let keyElement = newEnvVarDialog.querySelector("[modal-data-key]")
  let valueElement = newEnvVarDialog.querySelector("[modal-data-value]")
  // let saveBtn = newEnvVarDialog.querySelector("#saveBtn")

  // Fetch localStorage objects and convert to envVars array
  // const keys = Object.keys(localStorage).sort()
  const keys = Object.keys(localStorage).sort(function (a, b) {
    return a.toLowerCase().localeCompare(b.toLowerCase())
  })

  let envVars = []
  let envObj = {}
  keys.forEach((key) => {
    envObj = {}
    envObj.key = key
    envObj.value = localStorage[key]
    envVars.push(envObj)
  })

  // On load -> append query params key value pairs
  // An eventListener will be added to each Delete button
  envVars.forEach((envVar) => {
    document
      .querySelector("#{{ .Params.id }} [data-query-params]")
      .append(createKeyValuePair("{{ .Params.id }}", envVar.key, envVar.value))
  })

  // New Env Var button click -> "#newEnvVarBtn" button opens the <dialog> modally
  document
    .querySelector("#newEnvVarBtn")
    .addEventListener("click", function onOpen() {
      console.log("CLICK ENV VAR BTN")
      if (typeof newEnvVarDialog.showModal === "function") {
        console.log("NEW ENV VAR DIALOG", newEnvVarDialog)
        newEnvVarDialog.showModal()
      }
    })


  // Enter key listener -> Listen for the "Enter" key in newEnvVar modal
  newEnvVarDialog.addEventListener("keydown", (e) => {
    if (e.code === "Enter") {
      setLocalStorage()
    }
  })

  // Save listener -> On newEnvVar dialog "close" because of [method="dialog"]
  // Triggered via Cancel & Save buttons or Enter keypress
  newEnvVarDialog.addEventListener("close", function onClose() {
    if (newEnvVarDialog.returnValue !== "cancel") {
      setLocalStorage()
    }
  })

  // Store item in localStorage and refresh window
  function setLocalStorage() {
    if (keyElement.value !== "" && valueElement.value !== "") {
      localStorage.setItem(keyElement.value, valueElement.value)
      window.location = window.location.href
    }
  }
</script>
